<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Formularz badania ECHO</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800 p-4">
  <div class="max-w-4xl mx-auto py-6 bg-white shadow-lg rounded-lg">
    <!-- Nagłówek z logo -->
    <header class="flex flex-col md:flex-row items-center mb-6">
      <img src="logo_szpitala.png" alt="Logo szpitala" class="h-16 mr-4 mb-4 md:mb-0">
      <div>
        <h1 class="text-2xl font-bold">Klinika Kardiologii z Pododdziałem Ostrych Zespołów Wieńcowych</h1>
        <p>Kliniczny Szpital Wojewódzki Nr 2 im. Św. Jadwigi Królowej w Rzeszowie</p>
        <p>ul. Lwowska 60, 35-301 Rzeszów</p>
      </div>
    </header>

    <form id="echoForm" class="space-y-6">
      <!-- 1. Dane pacjenta -->
      <fieldset class="border p-4 rounded">
        <legend class="font-semibold">1. Dane pacjenta</legend>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
          <label class="block text-sm">Imię i nazwisko<br>
            <input name="patientName" type="text" class="mt-1 w-full border rounded p-2" required>
          </label>
          <label class="block text-sm">Nr badania / ID pacjenta<br>
            <input name="patientID" type="text" class="mt-1 w-full border rounded p-2" required>
          </label>
          <label class="block text-sm">Data badania<br>
            <input name="examDate" type="date" class="mt-1 w-full border rounded p-2" required>
          </label>
          <label class="block text-sm">Operator / lekarz<br>
            <input name="operator" type="text" class="mt-1 w-full border rounded p-2" required>
          </label>
        </div>
      </fieldset>

      <!-- 2. Wymiary jam serca -->
      <fieldset class="border p-4 rounded">
        <legend class="font-semibold">2. Wymiary jam serca (M-mode / 2D)</legend>
        <div id="dims" class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4"></div>
      </fieldset>

      <!-- 3. Średnice pni naczyniowych -->
      <fieldset class="border p-4 rounded">
        <legend class="font-semibold">3. Średnice pni naczyniowych</legend>
        <div id="ves" class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4"></div>
      </fieldset>

      <!-- 4. Objętości i funkcja skurczowa -->
      <fieldset class="border p-4 rounded">
        <legend class="font-semibold">4. Objętości i funkcja skurczowa</legend>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <label class="block text-sm">EF [%]<br>
            <input name="EF" type="number" step="any" class="mt-1 w-full border rounded p-2" required>
          </label>
          <label class="block text-sm">EDV [ml]<br>
            <input name="EDV" type="number" step="any" class="mt-1 w-full border rounded p-2">
          </label>
          <label class="block text-sm">ESV [ml]<br>
            <input name="ESV" type="number" step="any" class="mt-1 w-full border rounded p-2">
          </label>
        </div>
      </fieldset>

      <!-- 5. Odcinkowe zaburzenia kurczliwości -->
      <fieldset class="border p-4 rounded">
        <legend class="font-semibold">5. Odcinkowe zaburzenia kurczliwości</legend>
        <div class="flex items-center mt-4">
          <input type="checkbox" name="segmentalPresent" id="segmentalPresent" class="form-checkbox">
          <label for="segmentalPresent" class="ml-2 text-sm">Obecne</label>
        </div>
        <label class="block text-sm mt-4">Opis segmentów / uwagi<br>
          <textarea name="segmentalDescription" rows="3" class="mt-1 w-full border rounded p-2"></textarea>
        </label>
      </fieldset>

      <!-- 6. TAPSE -->
      <fieldset class="border p-4 rounded">
        <legend class="font-semibold">6. TAPSE</legend>
        <label class="block text-sm mt-4">Wartość [mm]<br>
          <input name="TAPSE" type="number" step="any" class="mt-1 w-32 border rounded p-2">
        </label>
      </fieldset>

      <!-- 7. Ocena zastawek -->
      <fieldset class="border p-4 rounded space-y-6">
        <legend class="font-semibold">7. Ocena zastawek</legend>

        <!-- Mitralna -->
        <div>
          <h3 class="font-semibold">7.1 Zastawka mitralna</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
            <label class="block text-sm">Stenoza<br>
              <select name="mitralStenosis" class="mt-1 w-full border rounded p-2">
                <option value="">-</option>
                <option>łagodna</option>
                <option>umiarkowana</option>
                <option>ciężka</option>
              </select>
            </label>
            <label class="block text-sm">Niedomykalność<br>
              <select name="mitralRegurg" class="mt-1 w-full border rounded p-2">
                <option value="">-</option>
                <option>łagodna</option>
                <option>umiarkowana</option>
                <option>ciężka</option>
              </select>
            </label>
          </div>
        </div>

        <!-- Aortalna -->
        <div>
          <h3 class="font-semibold">7.2 Zastawka aortalna</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
            <label class="block text-sm">Stenoza<br>
              <select name="aorticStenosis" class="mt-1 w-full border rounded p-2">
                <option value="">-</option>
                <option>łagodna</option>
                <option>umiarkowana</option>
                <option>ciężka</option>
              </select>
            </label>
            <label class="block text-sm">Niedomykalność<br>
              <select name="aorticRegurg" class="mt-1 w-full border rounded p-2">
                <option value="">-</option>
                <option>łagodna</option>
                <option>umiarkowana</option>
                <option>ciężka</option>
              </select>
            </label>
          </div>
        </div>

        <!-- Tricuspid -->
        <div>
          <h3 class="font-semibold">7.3 Zastawka trójdzielna</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
            <label class="block text-sm">Stenoza<br>
              <select name="tricuspidStenosis" class="mt-1 w-full border rounded p-2">
                <option value="">-</option>
                <option>łagodna</option>
                <option>umiarkowana</option>
                <option>ciężka</option>
              </select>
            </label>
            <label class="block text-sm">Niedomykalność<br>
              <select name="tricuspidRegurg" class="mt-1 w-full border rounded p-2">
                <option value="">-</option>
                <option>łagodna</option>
                <option>umiarkowana</option>
                <option>ciężka</option>
              </select>
            </label>
          </div>
        </div>
      </fieldset>

      <!-- 8. Osierdzie -->
      <fieldset class="border p-4 rounded">
        <legend class="font-semibold">8. Osierdzie</legend>
        <div class="flex items-center mt-4">
          <input type="checkbox" name="pericardEffusion" class="form-checkbox">
          <label class="ml-2 text-sm">Płyn w osierdziu</label>
        </div>
        <label class="block text-sm mt-4">Uwagi<br>
          <textarea name="pericardNotes" rows="2" class="mt-1 w-full border rounded p-2"></textarea>
        </label>
      </fieldset>

      <!-- 9. Uwagi końcowe -->
      <fieldset class="border p-4 rounded">
        <legend class="font-semibold">9. Uwagi końcowe i rekomendacje</legend>
        <textarea name="remarks" rows="3" class="mt-1 w-full border rounded p-2"></textarea>
      </fieldset>

      <!-- Przyciski eksportu -->
      <div class="flex gap-4 mt-6">
        <button type="button" id="exportCsv" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Eksportuj CSV</button>
        <button type="button" id="exportDocx" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Eksportuj DOCX</button>
      </div>
    </form>
  </div>

  <!-- Biblioteki -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html-docx-js@0.3.0/dist/html-docx.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
    // Render dynamic inputs (dims + ves)
    const dims = [
      'LVEDd (mm)','LVESd (mm)','IVSd (mm)','LVPWd (mm)',
      'LA (mm)','LAVI (ml/m2)','RAA (cm2)','RV (mm)'
    ];
    const ves = ['Opuszka aorty (mm)','Aorta wstępująca (mm)','Pień płucny (mm)'];
    const dimsContainer = document.getElementById('dims');
    dims.forEach(k=>{
      const lbl = document.createElement('label');
      lbl.className='block text-sm';
      lbl.innerHTML = `${k}<br><input name="${k}" type="number" step="any" class="mt-1 w-full border rounded p-2">`;
      dimsContainer.appendChild(lbl);
    });
    const vesContainer = document.getElementById('ves');
    ves.forEach(k=>{
      const lbl = document.createElement('label');
      lbl.className='block text-sm';
      lbl.innerHTML = `${k}<br><input name="${k}" type="number" step="any" class="mt-1 w-full border rounded p-2">`;
      vesContainer.appendChild(lbl);
    });

    // Collect form data
    function collect() {
      const data = {};
      new FormData(document.getElementById('echoForm')).forEach((v,k)=>data[k]=v);
      return data;
    }

    // CSV export
    document.getElementById('exportCsv').onclick = ()=>{
      const data = collect();
      // Headers = input/select names in order
      const headers = Array.from(new FormData(document.getElementById('echoForm')).keys());
      const values = headers.map(h=>data[h]||'');
      const csv = Papa.unparse({ fields: headers, data: [ values ] }, { delimiter: ';' });
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      saveAs(blob, `echo_${data.patientID||'record'}.csv`);
    };

    // DOCX export via html-docx-js
    document.getElementById('exportDocx').onclick = ()=>{
      const data = collect();
      // Build HTML for DOCX
      let html = `<h1>Raport badania ECHO</h1>
        <h2>Dane pacjenta</h2>
        <p><b>Imię i nazwisko:</b> ${data.patientName||''}</p>
        <p><b>ID pacjenta:</b> ${data.patientID||''}</p>
        <p><b>Data badania:</b> ${data.examDate||''}</p>
        <p><b>Operator:</b> ${data.operator||''}</p>
        <h2>Wymiary jam serca</h2><table>`;
      dims.forEach(k=>{
        html += `<tr><td><b>${k}</b></td><td>${data[k]||''}</td></tr>`;
      });
      html += `</table><h2>Średnice pni</h2><table>`;
      ves.forEach(k=>{
        html += `<tr><td><b>${k}</b></td><td>${data[k]||''}</td></tr>`;
      });
      html += `</table><h2>Objętości i EF</h2><table>
        <tr><td><b>EF [%]</b></td><td>${data.EF||''}</td></tr>
        <tr><td><b>EDV [ml]</b></td><td>${data.EDV||''}</td></tr>
        <tr><td><b>ESV [ml]</b></td><td>${data.ESV||''}</td></tr>
      </table>
      <h2>Odcinkowe zaburzenia kurczliwości</h2>
      <p><b>Obecne:</b> ${data.segmentalPresent?'Tak':'Nie'}</p>
      <p><b>Opis:</b> ${data.segmentalDescription||''}</p>
      <h2>TAPSE</h2><p>${data.TAPSE||''} mm</p>
      <h2>Ocena zastawek</h2>
      <h3>Mitralna</h3>
      <p><b>Stenoza:</b> ${data.mitralStenosis||''}</p>
      <p><b>Niedomykalność:</b> ${data.mitralRegurg||''}</p>
      <h3>Aortalna</h3>
      <p><b>Stenoza:</b> ${data.aorticStenosis||''}</p>
      <p><b>Niedomykalność:</b> ${data.aorticRegurg||''}</p>
      <h3>Trójdzielna</h3>
      <p><b>Stenoza:</b> ${data.tricuspidStenosis||''}</p>
      <p><b>Niedomykalność:</b> ${data.tricuspidRegurg||''}</p>
      <h2>Osierdzie</h2>
      <p><b>Płyn w osierdziu:</b> ${data.pericardEffusion?'Tak':'Nie'}</p>
      <p><b>Uwagi:</b> ${data.pericardNotes||''}</p>
      <h2>Uwagi końcowe</h2><p>${data.remarks||''}</p>`;
      // Convert to DOCX
      const blob = htmlDocx.asBlob(html);
      saveAs(blob, `raport_ECHO_${data.patientID||'form'}.docx`);
    };
  </script>
</body>
</html>
