<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formularz badania ECHO</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <!-- FileSaver.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <!-- html-docx-js -->
  <script src="https://cdn.jsdelivr.net/npm/html-docx-js@0.3.1/dist/html-docx.js"></script>
</head>
<body class="bg-gray-50 text-gray-800 p-4">
  <div class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden">
    <div class="p-6">
      <!-- Nagłówek -->
      <header class="flex flex-col md:flex-row items-center mb-6">
        <img src="logo_szpitala.png" alt="Logo szpitala" class="h-16 mr-4 mb-4 md:mb-0">
        <div>
          <h1 class="text-2xl font-bold">Klinika Kardiologii z Pododdziałem Ostrych Zespołów Wieńcowych</h1>
          <p>Kliniczny Szpital Wojewódzki Nr 2 im. Św. Jadwigi Królowej w Rzeszowie</p>
          <p>ul. Lwowska 60, 35-301 Rzeszów</p>
        </div>
      </header>

      <form id="echoForm" class="space-y-6">
        <!-- 1. Dane pacjenta -->
        <fieldset class="border p-4 rounded">
          <legend class="font-semibold">1. Dane pacjenta</legend>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
            <label class="block text-sm">Imię i nazwisko<br>
              <input name="patientName" type="text" class="mt-1 w-full border rounded p-2" required>
            </label>
            <label class="block text-sm">PESEL / ID pacjenta<br>
              <input name="patientID" type="text" class="mt-1 w-full border rounded p-2">
            </label>
            <label class="block text-sm">Wiek<br>
              <input name="patientAge" type="number" class="mt-1 w-full border rounded p-2">
            </label>
            <label class="block text-sm">Data badania<br>
              <input name="examDate" type="date" class="mt-1 w-full border rounded p-2">
            </label>
            <label class="block text-sm">Operator / lekarz<br>
              <input name="operator" type="text" class="mt-1 w-full border rounded p-2">
            </label>
          </div>
        </fieldset>

        <!-- 2. Wymiary jam serca -->
        <fieldset class="border p-4 rounded">
          <legend class="font-semibold">2. Wymiary jam serca (M-mode / 2D)</legend>
          <div id="dims" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mt-4">
            <!-- pola generowane w skrypcie -->
          </div>
        </fieldset>

        <!-- 3. Średnice pni naczyniowych -->
        <fieldset class="border p-4 rounded">
          <legend class="font-semibold">3. Średnice pni naczyniowych</legend>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mt-4">
            <label class="block text-sm">Opuszka aorty (mm)<br>
              <input name="aorticRootDiameter" type="number" step="0.1" class="mt-1 w-full border rounded p-2">
            </label>
            <label class="block text-sm">Aorta wstępująca (mm)<br>
              <input name="aortaAscendingDiameter" type="number" step="0.1" class="mt-1 w-full border rounded p-2">
            </label>
            <label class="block text-sm">Aorta zstępująca (mm)<br>
              <input name="aorticDescendingDiameter" type="number" step="0.1" class="mt-1 w-full border rounded p-2">
            </label>
            <label class="block text-sm">Pień płucny (mm)<br>
              <input name="MPA" type="number" step="0.1" class="mt-1 w-full border rounded p-2">
            </label>
          </div>
        </fieldset>

        <!-- 4. Objętości i EF -->
        <fieldset class="border p-4 rounded">
          <legend class="font-semibold">4. Objętości i funkcja skurczowa</legend>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mt-4">
            <label class="block text-sm">EF [%]<br>
              <input name="EF" type="number" step="0.1" class="mt-1 w-full border rounded p-2">
            </label>
            <label class="block text-sm">EDV [ml]<br>
              <input name="EDV" type="number" step="0.1" class="mt-1 w-full border rounded p-2">
            </label>
            <label class="block text-sm">ESV [ml]<br>
              <input name="ESV" type="number" step="0.1" class="mt-1 w-full border rounded p-2">
            </label>
          </div>
        </fieldset>

        <!-- 5. Odcinkowe zaburzenia kurczliwości -->
        <fieldset class="border p-4 rounded">
          <legend class="font-semibold">5. Odcinkowe zaburzenia kurczliwości</legend>
          <div class="mt-4">
            <label class="inline-flex items-center"><input type="checkbox" name="segmentalPresent" class="form-checkbox"><span class="ml-2">Obecne</span></label>
            <label class="block text-sm mt-4">Opis segmentów / uwagi<br>
              <textarea name="segmentalDescription" rows="3" class="mt-1 w-full border rounded p-2"></textarea>
            </label>
          </div>
        </fieldset>

        <!-- 6. TAPSE -->
        <fieldset class="border p-4 rounded">
          <legend class="font-semibold">6. TAPSE</legend>
          <label class="block text-sm mt-4">Wartość [mm]<br>
            <input name="TAPSE" type="number" step="0.1" class="mt-1 w-32 border rounded p-2">
          </label>
        </fieldset>

        <!-- 7. Ocena zastawek -->
        <fieldset class="border p-4 rounded space-y-6">
          <legend class="font-semibold">7. Ocena zastawek</legend>

          <!-- 7.1 Mitralna -->
          <div>
            <h3 class="font-semibold mb-2">7.1 Zastawka mitralna</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <label class="block text-sm">Stenoza<br>
                <select name="mitralStenosis" class="mt-1 w-full border rounded p-2">
                  <option value="">–</option><option>łagodna</option><option>umiarkowana</option><option>ciężka</option>
                </select>
              </label>
              <label class="block text-sm">Niedomykalność<br>
                <select name="mitralRegurg" class="mt-1 w-full border rounded p-2">
                  <option value="">–</option><option>łagodny</option><option>umiarkowany</option><option>średni</option>
                </select>
              </label>
              <label class="block text-sm">VC [cm]<br>
                <input name="mitralVC" type="number" step="0.01" class="mt-1 w-full border rounded p-2">
              </label>
              <label class="block text-sm">PISA [mm]<br>
                <input name="mitralPISA" type="number" step="0.1" class="mt-1 w-full border rounded p-2">
              </label>
              <label class="block text-sm">Pmax [mmHg]<br>
                <input name="mitralPmax" type="number" step="0.1" class="mt-1 w-full border rounded p-2">
              </label>
              <label class="block text-sm">Mmax [mmHg]<br>
                <input name="mitralMmax" type="number" step="0.1" class="mt-1 w-full border rounded p-2">
              </label>
              <label class="block text-sm">Vmax [m/s]<br>
                <input name="mitralVmax" type="number" step="0.01" class="mt-1 w-full border rounded p-2">
              </label>
            </div>
          </div>

          <!-- 7.2 Aortalna -->
          <div>
            <h3 class="font-semibold mb-2">7.2 Zastawka aortalna</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <label class="block text-sm">Stenoza<br>
                <select name="aorticStenosis" class="mt-1 w-full border rounded p-2">
                  <option value="">–</option><option>łagodna</option><option>umiarkowana</option><option>ciężka</option>
                </select>
              </label>
              <label class="block text-sm">Niedomykalność<br>
                <select name="aorticRegurg" class="mt-1 w-full border rounded p-2">
                  <option value="">–</option><option>łagodny</option><option>umiarkowany</option><option>średni</option>
                </select>
              </label>
              <label class="block text-sm">VC [cm]<br>
                <input name="aorticVC" type="number" step="0.01" class="mt-1 w-full border rounded p-2">
              </label>
              <label class="block text-sm">PISA [mm]<br>
                <input name="aorticPISA" type="number" step="0.1" class="mt-1 w-full border rounded p-2">
              </label>
              <label class="block text-sm">Pmax [mmHg]<br>
                <input name="aorticPmax" type="number" step="0.1" class="mt-1 w-full border rounded p-2">
              </label>
              <label class="block text-sm">Mmax [mmHg]<br>
                <input name="aorticMmax" type="number" step="0.1" class="mt-1 w-full border rounded p-2">
              </label>
              <label class="block text-sm">Vmax [m/s]<br>
                <input name="aorticVmax" type="number" step="0.01" class="mt-1 w-full border rounded p-2">
              </label>
              <label class="block text-sm">Opuszka aorty [mm]<br>
                <input name="aorticRootDiameter" type="number" step="0.1" class="mt-1 w-full border rounded p-2">
              </label>
              <label class="block text-sm">Aorta zstępująca [mm]<br>
                <input name="aorticDescendingDiameter" type="number" step="0.1" class="mt-1 w-full border rounded p-2">
              </label>
            </div>
          </div>

          <!-- 7.3 Trójdzielna -->
          <div>
            <h3 class="font-semibold mb-2">7.3 Zastawka trójdzielna</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <label class="block text-sm">Stenoza<br>
                <select name="tricuspidStenosis" class="mt-1 w-full border rounded p-2">
                  <option value="">–</option><option>łagodna</option><option>umiarkowana</option><option>ciężka</option>
                </select>
              </label>
              <label class="block text-sm">Niedomykalność<br>
                <select name="tricuspidRegurg" class="mt-1 w-full border rounded p-2">
                  <option value="">–</option><option>łagodny</option><option>umiarkowany</option><option>średni</option>
                </select>
              </label>
              <label class="block text-sm">VC [cm]<br>
                <input name="tricuspidVC" type="number" step="0.01" class="mt-1 w-full border rounded p-2">
              </label>
              <label class="block text-sm">PISA [mm]<br>
                <input name="tricuspidPISA" type="number" step="0.1" class="mt-1 w-full border rounded p-2">
              </label>
              <label class="block text-sm">Pmax [mmHg]<br>
                <input name="tricuspidPmax" type="number" step="0.1" class="mt-1 w-full border rounded p-2">
              </label>
              <label class="block text-sm">Mmax [mmHg]<br>
                <input name="tricuspidMmax" type="number" step="0.1" class="mt-1 w-full border rounded p-2">
              </label>
              <label class="block text-sm">Vmax [m/s]<br>
                <input name="tricuspidVmax" type="number" step="0.01" class="mt-1 w-full border rounded p-2">
              </label>
              <label class="block text-sm">Odległość od pierścienia [mm]<br>
                <input name="tricuspidAnnulusDistance" type="number" step="0.1" class="mt-1 w-full border rounded p-2">
              </label>
            </div>
          </div>
        </fieldset>

        <!-- 8. Osierdzie -->
        <fieldset class="border p-4 rounded">
          <legend class="font-semibold">8. Osierdzie</legend>
          <div class="mt-4">
            <label class="inline-flex items-center"><input type="checkbox" name="pericardEffusion" class="form-checkbox"><span class="ml-2">Płyn w osierdziu</span></label>
            <label class="block text-sm mt-4">Uwagi<br>
              <textarea name="pericardNotes" rows="2" class="mt-1 w-full border rounded p-2"></textarea>
            </label>
          </div>
        </fieldset>

        <!-- 9. Uwagi końcowe -->
        <fieldset class="border p-4 rounded">
          <legend class="font-semibold">9. Uwagi końcowe i rekomendacje</legend>
          <textarea name="remarks" rows="3" class="mt-1 w-full border rounded p-2"></textarea>
        </fieldset>

        <!-- Przyciski eksportu -->
        <div class="flex space-x-4 pt-4">
          <button type="button" id="exportCsv" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Eksportuj CSV</button>
          <button type="button" id="exportDocx" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Eksportuj DOCX</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Dodaj pola wymiary jam (z LAVI)
    const dims = ['LVEDd (mm)','LVESd (mm)','IVSd (mm)','LVPWd (mm)','LA (mm)','LAVI (ml/m²)','RV (mm)'];
    const dimsContainer = document.getElementById('dims');
    dims.forEach(k=>{
      const l = document.createElement('label');
      l.className = 'block text-sm';
      l.innerHTML = `${k}<br><input name="${k}" type="number" step="0.1" class="mt-1 w-full border rounded p-2">`;
      dimsContainer.appendChild(l);
    });

    // Zbiera wszystkie dane
    function collect() {
      const fm = new FormData(document.getElementById('echoForm')), o={};
      fm.forEach((v,k)=>o[k]=v);
      return o;
    }

    // Eksport CSV
    document.getElementById('exportCsv').onclick = ()=>{
      const d = collect();
      // PapaParse unparse single object with header row
      const csv = Papa.unparse([d], { header: true, delimiter: ';' });
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      saveAs(blob, `echo_${d.patientID||'record'}.csv`);
    };

    // Eksport DOCX
    document.getElementById('exportDocx').onclick = async ()=>{
      const d = collect();
      // Pobierz logo jako base64
      let logoData = '';
      await fetch('logo_szpitala.png').then(r=>r.blob()).then(blob=>{
        return new Promise(res=>{
          const reader=new FileReader();
          reader.onload=()=>res(reader.result);
          reader.readAsDataURL(blob);
        });
      }).then(dataURI=>logoData=dataURI);

      // Buduj HTML
      let html = `<html><head><meta charset="UTF-8"/></head><body>`;
      html += `<table style="width:100%;border-bottom:1px solid #000"><tr>
        <td style="width:80px"><img src="${logoData}" style="max-width:80px"/></td>
        <td style="vertical-align:middle"><h1 style="margin:0;font-size:16pt">Klinika Kardiologii</h1>
        <p style="margin:0">Szpital Wojewódzki NR 2, Rzeszów</p></td>
      </tr></table><br/>`;

      // Dane pacjenta
      html += `<h2>Dane pacjenta</h2><table>`;
      ['patientName','patientID','patientAge','examDate','operator']
        .forEach(key=>{
          if(d[key]) html+=`<tr><td><b>${key.replace(/([A-Z])/g,' $1')}</b></td><td>${d[key]}</td></tr>`;
        });
      html += `</table><br/>`;

      // Wymiary jam
      html += `<h2>Wymiary jam serca</h2><table border="1" cellspacing="0" cellpadding="4" style="border-collapse:collapse">`;
      dims.forEach(k=>{
        if(d[k]) html+=`<tr><td>${k}</td><td>${d[k]}</td></tr>`;
      });
      html += `</table><br/>`;

      // Średnice pni
      html += `<h2>Średnice pni naczyniowych</h2><table border="1" cellspacing="0" cellpadding="4" style="border-collapse:collapse">`;
      ['aorticRootDiameter','aortaAscendingDiameter','aorticDescendingDiameter','MPA']
        .forEach(k=>{
          if(d[k]) html+=`<tr><td>${k.replace(/([A-Z])/g,' $1')}</td><td>${d[k]}</td></tr>`;
        });
      html += `</table><br/>`;

      // EF i ESV/EDV/TAPSE
      html += `<h2>Funkcja skurczowa i TAPSE</h2><table border="1" cellspacing="0" cellpadding="4" style="border-collapse:collapse">`;
      ['EF','EDV','ESV','TAPSE'].forEach(k=>{
        if(d[k]) html+=`<tr><td>${k}</td><td>${d[k]}</td></tr>`;
      });
      html += `</table><br/>`;

      // Segmenty i osierdzie
      if(d.segmentalPresent || d.segmentalDescription) {
        html += `<h2>Segmenty</h2><p>Obecne: ${d.segmentalPresent?'Tak':'Nie'}</p>`;
        if(d.segmentalDescription) html+=`<p>${d.segmentalDescription}</p>`;
      }
      if(d.pericardEffusion || d.pericardNotes) {
        html += `<h2>Osierdzie</h2><p>Efuzja: ${d.pericardEffusion?'Tak':'Nie'}</p>`;
        if(d.pericardNotes) html+=`<p>${d.pericardNotes}</p>`;
      }

      // Ocena zastawek
      html += `<h2>Ocena zastawek</h2><table border="1" cellspacing="0" cellpadding="4" style="border-collapse:collapse">
        <tr><th>Zastawka</th><th>Stenoza</th><th>Niedomykalność</th><th>VC</th><th>PISA</th><th>Pmax</th><th>Mmax</th><th>Vmax</th><th>Odległość [mm]</th></tr>`;

      // Helper
      const valve = (name, keys)=>{
        const row = keys.map(k=>d[k]||'–');
        html+=`<tr><td>${name}</td>${row.map(v=>`<td>${v}</td>`).join('')}</tr>`;
      };

      valve('Mitralna', [
        'mitralStenosis','mitralRegurg','mitralVC','mitralPISA','mitralPmax','mitralMmax','mitralVmax',''
      ]);
      valve('Aortalna', [
        'aorticStenosis','aorticRegurg','aorticVC','aorticPISA','aorticPmax','aorticMmax','aorticVmax',''
      ]);
      valve('Trójdzielna', [
        'tricuspidStenosis','tricuspidRegurg','tricuspidVC','tricuspidPISA','tricuspidPmax','tricuspidMmax','tricuspidVmax','tricuspidAnnulusDistance'
      ]);

      html += `</table><br/>`;

      // Uwagi końcowe
      if(d.remarks) html += `<h2>Uwagi końcowe</h2><p>${d.remarks}</p>`;

      html += `</body></html>`;

      const blob = htmlDocx.asBlob(html);
      saveAs(blob, `echo_raport_${d.patientID||'form'}.docx`);
    };
  </script>
</body>
</html>
