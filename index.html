<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formularz ECHO</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse CDN -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <!-- FileSaver.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <!-- html-docx-js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/html-docx-js@0.3.1/dist/html-docx.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-4xl mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">Formularz badania echokardiograficznego (ECHO)</h1>
    <form id="echoForm" class="space-y-6">
      <!-- Patient Data -->
      <div>
        <h2 class="text-xl font-bold mb-2">Dane pacjenta</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block font-medium mb-1" for="patientName">Imię i nazwisko</label>
            <input type="text" id="patientName" name="patientName" class="w-full border border-gray-300 rounded px-3 py-2" required>
          </div>
          <div>
            <label class="block font-medium mb-1" for="patientID">PESEL</label>
            <input type="text" id="patientID" name="patientID" class="w-full border border-gray-300 rounded px-3 py-2">
          </div>
          <div>
            <label class="block font-medium mb-1" for="patientAge">Wiek</label>
            <input type="number" id="patientAge" name="patientAge" class="w-full border border-gray-300 rounded px-3 py-2">
          </div>
          <div>
            <label class="block font-medium mb-1" for="examDate">Data badania</label>
            <input type="date" id="examDate" name="examDate" class="w-full border border-gray-300 rounded px-3 py-2">
          </div>
        </div>
      </div>
      <!-- Measurements -->
      <div>
        <h2 class="text-xl font-bold mb-2">Wymiary jam serca</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block font-medium mb-1" for="LVDd">LVDd (mm)</label>
            <input type="number" step="0.1" id="LVDd" name="LVDd" class="w-full border border-gray-300 rounded px-3 py-2">
          </div>
          <div>
            <label class="block font-medium mb-1" for="LVDs">LVDs (mm)</label>
            <input type="number" step="0.1" id="LVDs" name="LVDs" class="w-full border border-gray-300 rounded px-3 py-2">
          </div>
          <div>
            <label class="block font-medium mb-1" for="IVSd">IVSd (mm)</label>
            <input type="number" step="0.1" id="IVSd" name="IVSd" class="w-full border border-gray-300 rounded px-3 py-2">
          </div>
          <div>
            <label class="block font-medium mb-1" for="PWDd">PWDd (mm)</label>
            <input type="number" step="0.1" id="PWDd" name="PWDd" class="w-full border border-gray-300 rounded px-3 py-2">
          </div>
          <div>
            <label class="block font-medium mb-1" for="LA">LA (mm)</label>
            <input type="number" step="0.1" id="LA" name="LA" class="w-full border border-gray-300 rounded px-3 py-2">
          </div>
          <div>
            <label class="block font-medium mb-1" for="Ao">Ao (mm)</label>
            <input type="number" step="0.1" id="Ao" name="Ao" class="w-full border border-gray-300 rounded px-3 py-2">
          </div>
          <div>
            <label class="block font-medium mb-1" for="RV">RV (mm)</label>
            <input type="number" step="0.1" id="RV" name="RV" class="w-full border border-gray-300 rounded px-3 py-2">
          </div>
        </div>
      </div>
      <!-- Valves -->
      <div>
        <h2 class="text-xl font-bold mb-2">Ocena zastawek</h2>
        <div class="space-y-2">
          <div class="flex flex-wrap items-center space-x-4">
            <span class="font-medium w-24">Mitralna:</span>
            <label class="font-medium">Stenoza 
              <select id="mitralStenosis" name="mitralStenosis" class="border border-gray-300 rounded px-2 py-1 ml-1">
                <option>Brak</option>
                <option>Łagodna</option>
                <option>Umiarkowana</option>
                <option>Ciężka</option>
              </select>
            </label>
            <label class="font-medium ml-2">Niedomykalność 
              <select id="mitralRegurg" name="mitralRegurg" class="border border-gray-300 rounded px-2 py-1 ml-1">
                <option>Brak</option>
                <option>I°</option>
                <option>II°</option>
                <option>III°</option>
                <option>IV°</option>
              </select>
            </label>
          </div>
          <div class="flex flex-wrap items-center space-x-4">
            <span class="font-medium w-24">Aortalna:</span>
            <label class="font-medium">Stenoza 
              <select id="aorticStenosis" name="aorticStenosis" class="border border-gray-300 rounded px-2 py-1 ml-1">
                <option>Brak</option>
                <option>Łagodna</option>
                <option>Umiarkowana</option>
                <option>Ciężka</option>
              </select>
            </label>
            <label class="font-medium ml-2">Niedomykalność 
              <select id="aorticRegurg" name="aorticRegurg" class="border border-gray-300 rounded px-2 py-1 ml-1">
                <option>Brak</option>
                <option>I°</option>
                <option>II°</option>
                <option>III°</option>
                <option>IV°</option>
              </select>
            </label>
          </div>
          <div class="flex flex-wrap items-center space-x-4">
            <span class="font-medium w-24">Trójdzielna:</span>
            <label class="font-medium">Stenoza 
              <select id="tricuspidStenosis" name="tricuspidStenosis" class="border border-gray-300 rounded px-2 py-1 ml-1">
                <option>Brak</option>
                <option>Łagodna</option>
                <option>Umiarkowana</option>
                <option>Ciężka</option>
              </select>
            </label>
            <label class="font-medium ml-2">Niedomykalność 
              <select id="tricuspidRegurg" name="tricuspidRegurg" class="border border-gray-300 rounded px-2 py-1 ml-1">
                <option>Brak</option>
                <option>I°</option>
                <option>II°</option>
                <option>III°</option>
                <option>IV°</option>
              </select>
            </label>
          </div>
        </div>
      </div>
      <!-- Systolic function & TAPSE -->
      <div>
        <h2 class="text-xl font-bold mb-2">Funkcja skurczowa i TAPSE</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block font-medium mb-1" for="EF">EF (%)</label>
            <input type="number" step="0.1" id="EF" name="EF" class="w-full border border-gray-300 rounded px-3 py-2">
          </div>
          <div>
            <label class="block font-medium mb-1" for="TAPSE">TAPSE (mm)</label>
            <input type="number" step="0.1" id="TAPSE" name="TAPSE" class="w-full border border-gray-300 rounded px-3 py-2">
          </div>
        </div>
      </div>
      <!-- Segmenty -->
      <div>
        <h2 class="text-xl font-bold mb-2">Segmenty</h2>
        <textarea id="segments" name="segments" rows="2" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Np. Bez odcinkowych zaburzeń kurczliwości."></textarea>
      </div>
      <!-- Osierdzie -->
      <div>
        <h2 class="text-xl font-bold mb-2">Osierdzie</h2>
        <input type="text" id="pericardium" name="pericardium" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Np. Bez płynu w osierdziu.">
      </div>
      <!-- Uwagi końcowe -->
      <div>
        <h2 class="text-xl font-bold mb-2">Uwagi końcowe</h2>
        <textarea id="remarks" name="remarks" rows="3" class="w-full border border-gray-300 rounded px-3 py-2"></textarea>
      </div>
      <!-- Export Buttons -->
      <div class="flex space-x-4 pt-4">
        <button type="button" id="exportCsvBtn" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded">Eksport CSV</button>
        <button type="button" id="exportDocxBtn" class="bg-green-600 text-white font-semibold px-4 py-2 rounded">Eksport do DOCX</button>
      </div>
    </form>
  </div>
  <script>
    // Prepare logo as base64 for DOCX embedding
    let logoBase64 = "";
    fetch('logo_szpitala.png')
      .then(response => response.blob())
      .then(blob => {
        const reader = new FileReader();
        reader.onload = function() {
          logoBase64 = reader.result;
        };
        reader.readAsDataURL(blob);
      });
    // Export to CSV
    document.getElementById('exportCsvBtn').addEventListener('click', () => {
      const data = {};
      data['Imię i nazwisko'] = document.getElementById('patientName').value;
      data['PESEL'] = document.getElementById('patientID').value;
      data['Wiek'] = document.getElementById('patientAge').value;
      data['Data badania'] = document.getElementById('examDate').value;
      data['LVDd'] = document.getElementById('LVDd').value;
      data['LVDs'] = document.getElementById('LVDs').value;
      data['IVSd'] = document.getElementById('IVSd').value;
      data['PWDd'] = document.getElementById('PWDd').value;
      data['LA'] = document.getElementById('LA').value;
      data['Ao'] = document.getElementById('Ao').value;
      data['RV'] = document.getElementById('RV').value;
      data['Stenoza mitralna'] = document.getElementById('mitralStenosis').value;
      data['Niedomykalność mitralna'] = document.getElementById('mitralRegurg').value;
      data['Stenoza aortalna'] = document.getElementById('aorticStenosis').value;
      data['Niedomykalność aortalna'] = document.getElementById('aorticRegurg').value;
      data['Stenoza trójdzielna'] = document.getElementById('tricuspidStenosis').value;
      data['Niedomykalność trójdzielna'] = document.getElementById('tricuspidRegurg').value;
      data['EF'] = document.getElementById('EF').value;
      data['TAPSE'] = document.getElementById('TAPSE').value;
      data['Segmenty'] = document.getElementById('segments').value;
      data['Osierdzie'] = document.getElementById('pericardium').value;
      data['Uwagi końcowe'] = document.getElementById('remarks').value;
      const csv = Papa.unparse([data], { header: true });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      saveAs(blob, 'ECHO_raport.csv');
    });
    // Export to DOCX
    document.getElementById('exportDocxBtn').addEventListener('click', () => {
      // Gather values
      const name = document.getElementById('patientName').value;
      const pesel = document.getElementById('patientID').value;
      const age = document.getElementById('patientAge').value;
      const date = document.getElementById('examDate').value;
      const LVDd = document.getElementById('LVDd').value;
      const LVDs = document.getElementById('LVDs').value;
      const IVSd = document.getElementById('IVSd').value;
      const PWDd = document.getElementById('PWDd').value;
      const LA = document.getElementById('LA').value;
      const Ao = document.getElementById('Ao').value;
      const RV = document.getElementById('RV').value;
      const mSten = document.getElementById('mitralStenosis').value;
      const mReg = document.getElementById('mitralRegurg').value;
      const aSten = document.getElementById('aorticStenosis').value;
      const aReg = document.getElementById('aorticRegurg').value;
      const tSten = document.getElementById('tricuspidStenosis').value;
      const tReg = document.getElementById('tricuspidRegurg').value;
      const EF = document.getElementById('EF').value;
      const TAPSE = document.getElementById('TAPSE').value;
      const segments = document.getElementById('segments').value;
      const pericardium = document.getElementById('pericardium').value;
      const remarks = document.getElementById('remarks').value;
      // Build HTML content for Word document
      let docHTML = '<html><head><meta charset="UTF-8"></head><body>';
      // Header with logo and hospital info
      docHTML += '<table style="width:100%; border-bottom:1px solid #000;"><tr>';
      docHTML += '<td style="width:100px;"><img src="' + logoBase64 + '" style="max-width:100px;"></td>';
      docHTML += '<td style="text-align:left; vertical-align:middle;">';
      docHTML += '<p style="font-size:14pt; font-weight:bold; margin:0;">Nazwa Szpitala</p>';
      docHTML += '<p style="font-size:12pt; font-weight:bold; margin:0;">Nazwa Kliniki</p>';
      docHTML += '</td></tr></table><br>';
      // Patient data table
      docHTML += '<p><strong>Dane pacjenta:</strong></p>';
      docHTML += '<table style="width:100%; border-collapse: collapse;">';
      if(name) docHTML += '<tr><td style="font-weight:bold;">Imię i nazwisko:</td><td>' + name + '</td></tr>';
      if(pesel) docHTML += '<tr><td style="font-weight:bold;">PESEL:</td><td>' + pesel + '</td></tr>';
      if(age) docHTML += '<tr><td style="font-weight:bold;">Wiek:</td><td>' + age + '</td></tr>';
      if(date) docHTML += '<tr><td style="font-weight:bold;">Data badania:</td><td>' + date + '</td></tr>';
      docHTML += '</table><br>';
      // Measurements table
      docHTML += '<p><strong>Wymiary jam serca:</strong></p>';
      docHTML += '<table style="width:100%; border-collapse: collapse;" border="1"><tbody>';
      if(LVDd) docHTML += '<tr><td>LVDd (mm)</td><td>' + LVDd + '</td></tr>';
      if(LVDs) docHTML += '<tr><td>LVDs (mm)</td><td>' + LVDs + '</td></tr>';
      if(IVSd) docHTML += '<tr><td>IVSd (mm)</td><td>' + IVSd + '</td></tr>';
      if(PWDd) docHTML += '<tr><td>PWDd (mm)</td><td>' + PWDd + '</td></tr>';
      if(LA) docHTML += '<tr><td>LA (mm)</td><td>' + LA + '</td></tr>';
      if(Ao) docHTML += '<tr><td>Ao (mm)</td><td>' + Ao + '</td></tr>';
      if(RV) docHTML += '<tr><td>RV (mm)</td><td>' + RV + '</td></tr>';
      docHTML += '</tbody></table><br>';
      // Valves table
      docHTML += '<p><strong>Zastawki:</strong></p>';
      docHTML += '<table style="width:100%; border-collapse: collapse;" border="1"><thead><tr><th></th><th>Stenoza</th><th>Niedomykalność</th></tr></thead><tbody>';
      docHTML += '<tr><td style="font-weight:bold;">Mitralna</td><td>' + mSten + '</td><td>' + mReg + '</td></tr>';
      docHTML += '<tr><td style="font-weight:bold;">Aortalna</td><td>' + aSten + '</td><td>' + aReg + '</td></tr>';
      docHTML += '<tr><td style="font-weight:bold;">Trójdzielna</td><td>' + tSten + '</td><td>' + tReg + '</td></tr>';
      docHTML += '</tbody></table><br>';
      // Systolic function & TAPSE table
      docHTML += '<p><strong>Funkcja skurczowa i TAPSE:</strong></p>';
      docHTML += '<table style="width:100%; border-collapse: collapse;" border="1"><tbody>';
      if(EF) docHTML += '<tr><td>EF (%)</td><td>' + EF + '%</td></tr>';
      if(TAPSE) docHTML += '<tr><td>TAPSE (mm)</td><td>' + TAPSE + ' mm</td></tr>';
      docHTML += '</tbody></table><br>';
      // Segments, Pericardium, Remarks
      if(segments) {
        docHTML += '<p><strong>Segmenty:</strong> ' + segments + '</p>';
      }
      if(pericardium) {
        docHTML += '<p><strong>Osierdzie:</strong> ' + pericardium + '</p>';
      }
      if(remarks) {
        docHTML += '<p><strong>Uwagi końcowe:</strong> ' + remarks + '</p>';
      }
      docHTML += '</body></html>';
      // Generate and save DOCX
      const converted = window.htmlDocx.asBlob(docHTML);
      saveAs(converted, 'ECHO_raport.docx');
    });
  </script>
</body>
</html>
